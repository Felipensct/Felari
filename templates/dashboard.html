{% extends "base.html" %}

{% block body %}
<div class="container product">
  <div class="row">
    <div class="col-12 product-container">
      <h1>Dashboard</h1>
      <form method="POST" id="ordem-form">
        <label for="ordem">Selecione uma Ordem de Produção:</label>
        <select name="ordem_id" id="ordem">
          <option value="">Selecione</option>
          {% for ordem in ordens %}
          <option value="{{ ordem.id }}">{{ ordem.produto.nome }} - Ordem #{{ ordem.id }}</option>
          {% endfor %}
        </select>
      </form>
      <h5 id="selected-ordem-info" style="margin-top: 20px;">
        {% if selected_produto_nome and selected_ordem_numero %}
          <strong>Produto Selecionado:</strong> {{ selected_produto_nome }} <br>
          <strong>Número da Ordem de Produção:</strong> {{ selected_ordem_numero }}
        {% endif %}
      </h5>
      <canvas id="myChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('myChart').getContext('2d');
    const data = {{ chart_data|safe }};
    const labels = data.labels;
    const expectedData = data.expectedData;
    const trackedData = data.trackedData;

    const myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
            label: 'Quantidade Esperada',
            data: expectedData,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Quantidade Rastreada',
            data: trackedData,
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Capturar mudança no select sem recarregar a página
    const ordemSelect = document.getElementById('ordem');
    const selectedOrdemInfo = document.getElementById('selected-ordem-info');

    ordemSelect.addEventListener('change', function () {
      const selectedOption = ordemSelect.options[ordemSelect.selectedIndex];
      const produtoNome = selectedOption.textContent.split(' - ')[0];
      const ordemId = selectedOption.textContent.split(' - ')[1].replace('Ordem #', '');

      selectedOrdemInfo.innerHTML = `
        <strong>Produto Selecionado:</strong> ${produtoNome} <br>
        <strong>Número da Ordem de Produção:</strong> ${ordemId}
      `;

      // Submeter o formulário ao selecionar uma opção
      document.getElementById('ordem-form').submit();
    });
  });
</script>
{% endblock %}
